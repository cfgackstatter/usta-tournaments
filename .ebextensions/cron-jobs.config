files:
  "/etc/cron.d/app_update_job":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Run update at midnight daily
      0 0 * * * root /usr/local/bin/update_script.sh >> /var/log/app-updates.log 2>&1

  "/usr/local/bin/update_script.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Navigate to application directory
      cd /var/app/current || exit 1
      
      # Activate virtual environment
      source /var/app/venv/staging-LQM1lest/bin/activate
      
      # Run update job with 100 pages to get all tournaments
      echo "Starting update job at $(date)" >> /var/log/app-updates.log
      echo "Using Python: $(which python3)" >> /var/log/app-updates.log
      python3 main.py --update --max-pages 100 >> /var/log/app-updates.log 2>&1
      
      # Check if update succeeded
      if [ $? -eq 0 ]; then
        echo "Update successful at $(date)" >> /var/log/app-updates.log
      else
        echo "Update failed at $(date)" >> /var/log/app-updates.log
      fi
      
      echo "Update process completed at $(date)" >> /var/log/app-updates.log
      exit 0

commands:
  remove_old_cron:
    command: "rm -f /etc/cron.d/app_update_job.bak"
    ignoreErrors: true
  reload_cron:
    command: "systemctl reload crond || service crond reload"
    ignoreErrors: true