files:
  "/etc/cron.d/app_update_job":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Run update at midnight daily
      0 0 * * * root /usr/local/bin/update_script.sh >> /var/log/app-updates.log 2>&1

  "/usr/local/bin/update_script.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      # Source environment variables
      . /opt/elasticbeanstalk/support/envvars

      # Navigate to application directory
      cd /var/app/current

      # Run update job with full Python path
      echo "Starting update job at $(date)" >> /var/log/app-updates.log
      /var/app/venv/*/bin/python main.py --update >> /var/log/app-updates.log 2>&1

      # Check if update succeeded
      if [ $? -eq 0 ]; then
        echo "Update successful, restarting application at $(date)" >> /var/log/app-updates.log
        # Restart application server
        systemctl restart web.service >> /var/log/app-updates.log 2>&1
      else
        echo "Update failed at $(date)" >> /var/log/app-updates.log
      fi

      echo "Update process completed at $(date)" >> /var/log/app-updates.log
      exit 0

commands:
  remove_old_cron:
    command: "rm -f /etc/cron.d/app_update_job.bak"
    ignoreErrors: true
  reload_cron:
    command: "service cron reload || service crond reload"
    ignoreErrors: true