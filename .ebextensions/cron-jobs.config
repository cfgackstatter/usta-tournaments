files:
  "/etc/cron.d/app_update_job":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Run update at midnight daily
      0 0 * * * root /usr/local/bin/update_script.sh >> /var/log/app-updates.log 2>&1

  "/usr/local/bin/update_script.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Navigate to application directory
      cd /var/app/current || exit 1
      
      # Find Python in venv
      PYTHON_PATH=$(find /var/app/venv -name python3 -type f 2>/dev/null | head -1)
      
      if [ -z "$PYTHON_PATH" ]; then
        echo "ERROR: Python not found in venv at $(date)" >> /var/log/app-updates.log
        exit 1
      fi
      
      # Run update job
      echo "Starting update job at $(date)" >> /var/log/app-updates.log
      $PYTHON_PATH main.py --update >> /var/log/app-updates.log 2>&1
      
      # Check if update succeeded
      if [ $? -eq 0 ]; then
        echo "Update successful at $(date)" >> /var/log/app-updates.log
      else
        echo "Update failed at $(date)" >> /var/log/app-updates.log
      fi
      
      echo "Update process completed at $(date)" >> /var/log/app-updates.log
      exit 0

commands:
  remove_old_cron:
    command: "rm -f /etc/cron.d/app_update_job.bak"
    ignoreErrors: true
  reload_cron:
    command: "systemctl reload crond || service crond reload"
    ignoreErrors: true