# .ebextensions/03_cron.config
# Sets up cron daemon and daily tournament data update job

commands:
  01_enable_crond:
    command: "systemctl enable crond.service"
    ignoreErrors: true
  02_start_crond:
    command: "systemctl start crond.service || service crond start"
    ignoreErrors: true
  03_verify_crond:
    command: "systemctl is-active crond.service || echo 'Warning: crond may not be running'"
    ignoreErrors: true

files:
  "/etc/cron.d/app_update_job":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Run tournament data update at midnight daily (UTC)
      0 0 * * * root /usr/local/bin/update_script.sh >> /var/log/app-updates.log 2>&1

  "/usr/local/bin/update_script.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Navigate to application directory
      cd /var/app/current || exit 1
      
      # Activate virtual environment
      source /var/app/venv/*/bin/activate
      
      # Set PYTHONPATH
      export PYTHONPATH="/var/app/current:/var/app/current/backend:$PYTHONPATH"
      
      # Run update job with 100 pages to get all tournaments
      echo "===== Starting update job at $(date) =====" >> /var/log/app-updates.log
      echo "Python location: $(which python3)" >> /var/log/app-updates.log
      echo "PYTHONPATH: $PYTHONPATH" >> /var/log/app-updates.log
      
      python3 -m backend.main --update --max-pages 100 >> /var/log/app-updates.log 2>&1
      
      # Check if update succeeded
      if [ $? -eq 0 ]; then
        echo "✓ Update successful at $(date)" >> /var/log/app-updates.log
      else
        echo "✗ Update failed at $(date) with exit code $?" >> /var/log/app-updates.log
      fi
      
      echo "===== Update process completed at $(date) =====" >> /var/log/app-updates.log
      echo "" >> /var/log/app-updates.log
      exit 0

commands:
  04_remove_old_cron:
    command: "rm -f /etc/cron.d/app_update_job.bak"
    ignoreErrors: true
  05_reload_cron:
    command: "systemctl reload crond || service crond reload"
    ignoreErrors: true